
k exec -it -n ovn-kubernetes deploy/ovnkube-master -c ovn-northd -- bash

# ---------------------------------------------------------

ovn-sbctl --all destroy Controller_Event
ovn-nbctl --if-exists destroy Load_Balancer $uuid

uuid=`ovn-nbctl create Load_Balancer name=lb0`
ovn-nbctl add Load_Balancer $uuid vips "\"10.96.137.236:8000\"=\"\""
ovn-nbctl add Load_Balancer $uuid options event=false reject=true 
ovn-nbctl add Load_Balancer $uuid protocol tcp
group_uuid=`ovn-nbctl --columns=_uuid find Load_Balancer_Group name=clusterLBGroup | sed "s/.*: //"`
ovn-nbctl add Load_Balancer_Group $group_uuid load_balancer $uuid


[root@client-pod /]# curl 10.96.137.236:8000
curl: (7) Failed to connect to 10.96.137.236 port 8000: Connection refused

[root@ovn-control-plane ~]#  ovn-sbctl list Controller_Event
<no event>



# ---------------------------------------------------------

ovn-sbctl --all destroy Controller_Event
ovn-nbctl --if-exists destroy Load_Balancer $uuid

uuid=`ovn-nbctl create Load_Balancer name=lb0`
ovn-nbctl add Load_Balancer $uuid vips "\"10.96.137.236:8000\"=\"\""
ovn-nbctl add Load_Balancer $uuid options event=true reject=false
ovn-nbctl add Load_Balancer $uuid protocol tcp
group_uuid=`ovn-nbctl --columns=_uuid find Load_Balancer_Group name=clusterLBGroup | sed "s/.*: //"`
ovn-nbctl add Load_Balancer_Group $group_uuid load_balancer $uuid

[root@client-pod /]# curl -m 3  10.96.137.236:8000
curl: (28) Connection timed out after 3001 milliseconds


[root@ovn-control-plane ~]#  ovn-sbctl list Controller_Event
_uuid               : 5f98c26d-2c8e-42e3-b5f2-8bf7a9d521d0
chassis             : 57e8bff2-fcca-4054-a26d-081329682a7e
event_info          : {load_balancer="d7761b6c-b777-4168-9ac1-2c1a864c24f4", protocol=tcp, vip="10.96.137.236:8000"}
event_type          : empty_lb_backends
seq_num             : 2


[root@ovn-control-plane ~]# ovn-nbctl set Load_Balancer $uuid options:event=false
[root@ovn-control-plane ~]# ovn-nbctl find Load_Balancer name=lb0
_uuid               : d7761b6c-b777-4168-9ac1-2c1a864c24f4
external_ids        : {}
health_check        : []
ip_port_mappings    : {}
name                : lb0
options             : {event="false", reject="false"}
protocol            : tcp
selection_fields    : []
vips                : {"10.96.137.236:8000"=""}

# Clears any previous event
[root@ovn-control-plane ~]# ovn-sbctl --all destroy Controller_Event


[root@client-pod /]# curl -m 3  10.96.137.236:8000
curl: (28) Connection timed out after 3001 milliseconds

[root@ovn-control-plane ~]# ovn-sbctl list Controller_Event
_uuid               : b4a02803-a13c-4188-b0ca-9b5c11b7f3fb
chassis             : 57e8bff2-fcca-4054-a26d-081329682a7e
event_info          : {load_balancer="d7761b6c-b777-4168-9ac1-2c1a864c24f4", protocol=tcp, vip="10.96.137.236:8000"}
event_type          : empty_lb_backends
seq_num             : 3



# ---------------------------------------------------------

ovn-sbctl --all destroy Controller_Event
ovn-nbctl --if-exists destroy Load_Balancer $uuid
uuid=`ovn-nbctl create Load_Balancer name=lb0`

ovn-nbctl add Load_Balancer $uuid vips "\"10.96.137.236:8000\"=\"\""
ovn-nbctl add Load_Balancer $uuid options event=false reject=false
ovn-nbctl add Load_Balancer $uuid protocol tcp
group_uuid=`ovn-nbctl --columns=_uuid find Load_Balancer_Group name=clusterLBGroup | sed "s/.*: //"`
ovn-nbctl add Load_Balancer_Group $group_uuid load_balancer $uuid

[root@client-pod /]# curl -m 3  10.96.137.236:8000
curl: (28) Connection timed out after 3001 milliseconds


[root@ovn-control-plane ~]# ovn-sbctl list Controller_Event
_uuid               : 8bf8e847-24eb-4651-90a0-be26d044526e
chassis             : 57e8bff2-fcca-4054-a26d-081329682a7e
event_info          : {load_balancer="4319fa4a-f667-4034-b4bb-abc030459a2a", protocol=tcp, vip="10.96.137.236:8000"}
event_type          : empty_lb_backends
seq_num             : 6


# ---------------------------------------------------------

ovn-sbctl --all destroy Controller_Event
ovn-nbctl --if-exists destroy Load_Balancer $uuid
uuid=`ovn-nbctl create Load_Balancer name=lb0`

ovn-nbctl add Load_Balancer $uuid vips "\"10.96.137.236:8000\"=\"\""
ovn-nbctl add Load_Balancer $uuid options event=true reject=true
ovn-nbctl add Load_Balancer $uuid protocol tcp
group_uuid=`ovn-nbctl --columns=_uuid find Load_Balancer_Group name=clusterLBGroup | sed "s/.*: //"`
ovn-nbctl add Load_Balancer_Group $group_uuid load_balancer $uuid


#######################################################################################################

switch_uuid=`ovn-nbctl --columns=_uuid find Logical_Switch name=ovn-control-plane | sed "s/.*: //"`
group_uuid=`ovn-nbctl --columns=_uuid find Load_Balancer_Group name=clusterLBGroup | sed "s/.*: //"`
ovn-nbctl add Logical_Switch $switch_uuid load_balancer $uuid

ovn-nbctl find Load_Balancer name=lb0
ovn-sbctl lflow-list
ovn-sbctl list Controller_Event


ovn-nbctl  set NB_Global e61500dc-4f17-4af5-b349-eb7d9cc8c4c3  options:controller_event=false














[root@ovn-control-plane ~]# ovn-sbctl lflow-list | grep 137.236 | grep trigger
  table=7 (lr_in_dnat         ), priority=130  , match=(ip4.dst == 10.96.137.236 && tcp && tcp.dst == 8000), action=(trigger_event(event = "empty_lb_backends", vip = "10.96.137.236:8000", protocol = "tcp", load_balancer = "2eb2ad99-c3b9-4c9a-9bd4-fd6a02783b85");)
  table=7 (lr_in_dnat         ), priority=130  , match=(ip4.dst == 10.96.137.236 && tcp && tcp.dst == 8000), action=(trigger_event(event = "empty_lb_backends", vip = "10.96.137.236:8000", protocol = "tcp", load_balancer = "2eb2ad99-c3b9-4c9a-9bd4-fd6a02783b85");)
  table=7 (lr_in_dnat         ), priority=130  , match=(ip4.dst == 10.96.137.236 && tcp && tcp.dst == 8000), action=(trigger_event(event = "empty_lb_backends", vip = "10.96.137.236:8000", protocol = "tcp", load_balancer = "2eb2ad99-c3b9-4c9a-9bd4-fd6a02783b85");)
  table=5 (ls_in_pre_lb       ), priority=130  , match=(ip4.dst == 10.96.137.236 && tcp && tcp.dst == 8000), action=(trigger_event(event = "empty_lb_backends", vip = "10.96.137.236:8000", protocol = "tcp", load_balancer = "2eb2ad99-c3b9-4c9a-9bd4-fd6a02783b85");)
  table=5 (ls_in_pre_lb       ), priority=130  , match=(ip4.dst == 10.96.137.236 && tcp && tcp.dst == 8000), action=(trigger_event(event = "empty_lb_backends", vip = "10.96.137.236:8000", protocol = "tcp", load_balancer = "2eb2ad99-c3b9-4c9a-9bd4-fd6a02783b85");)
  table=5 (ls_in_pre_lb       ), priority=130  , match=(ip4.dst == 10.96.137.236 && tcp && tcp.dst == 8000), action=(trigger_event(event = "empty_lb_backends", vip = "10.96.137.236:8000", protocol = "tcp", load_balancer = "2eb2ad99-c3b9-4c9a-9bd4-fd6a02783b85");)